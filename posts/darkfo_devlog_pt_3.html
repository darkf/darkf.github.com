<!doctype html>
<html>
<head>
  <title>DarkFO Devlog Part III</title>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="../style.css"/>
</head>
<body>
<div id="content">
	<a href="http://darkf.github.io">&lt;</a> <span id="time">published June 19, 2014 </span>
	<br/><br/>
	<h2>DarkFO Devlog Part III</h2>
	<hr/>
	<p>It's been quite a while since the last update -- over 2 weeks. A lot has been done, a lot learned, a lot lost (mostly just sanity), and it's been fun. Let's talk a little bit about what some of that was.</p>
<h1>Animation</h1>
<p>This is one of my least favorite topics (surprise!), so let's cover this first.</p>
<p>One of the first major things I did since the last post was implement A* pathfinding over the hex grid.  This lets the player and NPCs find their way around the world, giving them an unblocked path to walk on, avoiding obstacles if necessary.
This was, all told, fairly simple. I had a mental block because non-square pathfinding gives me the creeps, but fortunately my friend helped me out with getting the position of hex neighbors, so that I could modify <a href="https://github.com/qiao/PathFinding.js/">PathFinding.js</a> to work with the hex grid.</p>
<p>Next you need to be able to actually, you know, <em>walk</em> -- so in came animating frames. For walking, it worked out fine! But then I ran into an issue with running -- running went 3 hexes instead of 2, like walking did.
After I hacked up a solution that worked with both of those, I tried it with other models (like   ghouls, for instance) and it broke. Ghouls used 11 frames to walk 2 steps, vs 4 to walk 1 step and 8 to walk 2 steps, for <code>JMPS</code> (the Vault 13 jumpsuit model used by the player for the first portion of the game).</p>
<p>It turns out, animation in <em>Fallout 2</em> is more complex than I had thought even previously: animations are also broken into sub-animations, which old FIFE called <em>partial animations</em>. For example, the walking animation for <code>JMPS</code> would advance 4 frames for the first step, and if it needed to go any further than that, advance the other 4 frames to the next partial. FIFE calculates these partials based on the total movement distance. The problem I have is <em>when</em> to play these animations -- if I am at the end of partial #2 for walking, for instance, what do I do now? Do I repeat partial #2 or go to partial #1? My experiments left me empty-handed for now.</p>
<p>Animation will likely be one of the last major things I tackle in this project, since it doesn't interest me a whole ton and it's not imperative until the point of polishing, essentially. Static animations play fine, even though movement animations such as walking or running are choppy and skip in the middle.</p>
<h1>Objects</h1>
<p>Objects got some pretty big improvements. <code>.PRO</code> (Prototype) files are loaded in for each object now, which gains us information about them. Each object in <em>Fallout 2</em> has a corresponding prototype, referenced by a <em>Prototype ID</em> (<em>PID</em>; although <em>PID</em> is seemingly ambiguously used to refer to both the prototype number and the object type, which make up 4-byte identifiers <code>0xTT00PPPP</code> -- T is a type, P is the index.) </p>
<p>For instance, for critters, the information given includes: stats, damage resistances, age, gender (surprisingly, a 4-byte integer for only the set {0, 1}), skills, the type of damage they deal (for NPCs), etc.</p>
<p>For items: attack mode (interestingly, this is only used for weapons, even though this field is common to all items and despite there being sub-type specific fields), item sub-type (weapon, ammo, drug, ...), weight (you have a limited carry capacity), cost (... and money), and a <em>PID</em> for the art when it is displayed as an inventory item.</p>
<p>There are a few sub-types: weapons contain what you'd expect (some information for the model to use, min/max damage, damage type (plasma, electrical, normal, ...), projectile PID (probably only for some guns, like the plasma rifle), minimum Strength stat to wield, PID of the ammo type it uses, the maximum ammo and magazine/clip/etc capacity.
Armor contains stats for blocking damage (DR/DT), drugs contain information on stats affected, duration of their effects, etc. Very useful stuff.</p>
<p>Inventory item count is also parsed -- so you may have 100 copies of the same gun in your inventory (should you be able to carry that much.)</p>
<p>Objects can also have a script associated with them. Common script types include critter scripts (they usually handle dialogue, bartering and hostilities; or, for peasants, wandering and speaking random messages), scenery (doors and locked containers), miscellaneous items (animated monitors and such use <code>ANIMFRVR</code> which does as you'd expect.)</p>
<h1>Scripting</h1>
<p>And so comes the meat of the article. Scripting, my favorite piece of the DarkFO puzzle.</p>
<p>Scripting causes me quite a bit of grief in this engine. It uses a weird, weakly typed, not well-defined Pascal/Oberon-inspired language -- which by the way is <em>case-insensitive</em>, so I need to knock all identifiers down to lowercase -- and the engine commands are not very well documented. The official map editor ships with <em>COMMANDS.DOC</em>, but it is either lacking, confusing, or just plain blatantly wrong. Likely half of commands (quite a few that I've seen) are undocumented entirely, some are mistyped, some have the wrong parameters (or perhaps they accept multiple types of arguments?)... it's, quite frankly, a mess. And I think the developers knew it.</p>
<p>So, after fixing some bugs in the transpiler (such as not writing grouping for operator precedence correctly), some more things started to work. I implemented <em>LVAR</em>s (which default to zero because that's what they do!), as well as stubbed some stat-related functions, and now NPC reactions work. <em>Fallout 2</em> includes a reaction system for a lot of NPCs with dialogue. It's simple: the more they like the actions you've done (populace of particular factions killed, your stance on slavery, how many children you've killed, etc.) and the more Charisma you have than them, the more they like you. Their disposition will be higher toward you, which can result in more friendly messages, special quests (like gaining party members!), or even a discount on bartering goods.</p>
<p>The next (and more recent) challenge was dealing with items and inventory related functionality. Scripts can, of course, check if items (referenced by their PID index -- I imagine, with the lack of type, these only refer to item types) are in an object's inventory, add items there, remove them, etc. Scripts can spawn arbitrary items (by PID index again(? What about non-item types? Maybe it accepts both, treating it as a full PID if the most significant bytes are non-zero?), and even attach an arbitrary script).</p>
<p>Of course UI was added to view object inventory, which shows their icons and relevant information (name and amount of them in the stack).</p>
<p>So, with this all implemented, what can we do now? Well... we can implement bartering!</p>
<p>And so I did. I chose to test this with Percy in Gecko's Junkyard. Wooz (in the Gecko Settlement) only sells booze, and not through the standard barter system, but through adding the booze directly in a script, and removing money.)</p>
<p>So, my first step was to get Percy's script running. Of course, I quickly ran into stuff <em>not existing</em>. For one thing, Percy uses <em>two containers</em> (footlockers outside of the map's scrolling bounds) -- one as a temporary box to store his personal inventory, and one to permanently store his store contents. These are object pointers that are imported (<code>import variable</code> FTW...) from the map script. Of course, the map script merely acts like a global container for these singletons (<code>export variable</code> FTW...), the actual scripts that set these container variables are <code>GIPERBOX</code> (for Percy's box) and <code>GIJNKBOX</code> (for the generic Gecko Junkyard box.)
These scripts are meant to be attached to a container item in the map editor, which then signifies <em>that container</em> as Percy's or the Junkyard's box. (This is just <code>import variable whichever_box; procedure map_enter_p_proc whichever_box := self_obj; end</code>).</p>
<h1>An Aside</h1>
<p><a href="darkfo-footlockers.png"><img src="darkfo-footlockers.png" alt="DarkFO Footlockers" width="800" height="570"></a></p>
<p>The problem was, I didn't see these scripts loaded in DarkFO. So I re-ran my map loader, figuring the map was just old. Nope, still not there... Where are they? I looked in the unofficial Mapper, neither seemed to be there, on those footlockers. What?</p>
<p>I scrambled looking over the modding wiki for documentation, for prototypes and maps. Indeed, it appeared correct -- so where was it getting <code>GIPERBOX</code> from? It <em>had</em> to load that (and <code>GIJNKBOX</code>, further) to work.</p>
<p>Well, there was one section I gloss over: <a href="http://falloutmods.wikia.com/wiki/MAP_File_Format#MAP_Scripts">Map Scripts</a>. This incredibly confusing and undocumented section of maps contains some weird table of scripts (I <em>don't know why</em>! I just realized that it could be due to them importing map variables, so maybe they are <code>extern</code> linked or something.)</p>
<p>Well, I hackily hacked together a hacky way to note those map scripts as well, and if the map script ID is there but the regular script ID isn't, use that table. Now we have <code>GIPERBOX</code> loading.</p>
<p>...Wait, what was that? No <code>GIJNKBOX</code>? No indeed. I double-checked my hacks, the script IDs... that left footlocker just <em>did not</em> have a script attached! How was this?</p>
<p>Now, I use the vanilla scripts released with Mapper, which are pre-1.02 patched, so I load the map in Mapper. Mapper has a feature to list all of the scripts used in the map by highlighting their name over the object. I clicked the menu item... and <code>GIPERBOX</code> displayed. Not <code>GIJNKBOX</code>. What? It has to load those from <em>somewhere</em> to work.</p>
<p>So I re-load my 1.02-patched maps, and reload them. Nope, not there. <em>What kind of magic is this?</em> At least the unofficial Mapper shows <code>GIPERBOX</code> now (it now uses a script ID instead of a map script ID, I believe. Huh.)</p>
<p>Well, I got to thinking. Maybe I am just crazy. No, maybe I am just overthinking it... I read Percy's script again.</p>
<pre><code>procedure talk_p_proc begin
   // ...
   move_inven_to_temp_box
   move_inven_from_box

   // ...
   move_inven_to_box
   move_inven_from_temp_box
end
</code></pre>
<p>Where <code>move_inven_{to,from}_temp_box</code> are defined as:</p>
<pre><code>#define move_inven_to_temp_box         move_obj_inven_to_obj(self_obj, gecko_junkyard_temp_box);
#define move_inven_from_temp_box       move_obj_inven_to_obj(gecko_junkyard_temp_box, self_obj);
</code></pre>
<p>Well, let's assume that the script <code>GIJNKBOX</code> wasn't loaded. The <code>gecko_junkyard_temp_box</code> pointer would be NULL (zero).</p>
<p>Well, if those functions were to fail silently on a NULL object pointer, and they did nothing, then Percy's personal inventory would not be transferred out to the temporary box, and would intermingle with his store goods.
I load up the game to check this. And... facepalm! Yep, he doesn't start with anything for a personal inventory. If you pickpocket some items onto him, and <em>then</em> barter with him, his personal inventory will still be there for bartering.</p>
<p>This is a bug in <em>Fallout 2</em>. It should <em>not</em> even be a bug! Even if the mappers forgot to attach the <code>GIJNKBOX</code> script to a container, <code>move_obj_inven_to_obj</code> should not <em>silently fail</em> on a NULL object pointer! If it had errored and alerted the scripters to this problem, this bug would not exist. <em>Sigh</em>.</p>
<h1>Back to Bartering</h1>
<p>So, today I implemented bartering. I implemented a dead simple temporary UI mostly mimicing the <em>Fallout 2</em> one: two panes for merchant/player inventory, and two more panes for the merchant/player bartering area. (This kind of imitates a wood table that you're bartering for goods on.)</p>
<p><a href="darkfo-barter.png"><img src="darkfo-barter.png" alt="DarkFO Bartering" width="800" height="420"></a></p>
<p>Additionally you can, like <em>Fallout 2</em>, only barter specific amounts on items. So if you only want to give the merchant 200 coins, go for it. It will prompt you.</p>
<p>After you're done swapping items between sides of the table, you can make an offer.
A successful offer is one where you offer equal to or more than the value you requested from the merchant. So, if you want their gun that's worth $500, better lay down some items of your own that cost a total of at least $500. ("Money", which are worth $1 each, usefully. They're also <a href="http://fallout.wikia.com/wiki/$1_NCR">gold-minted</a>. Mmm, minty.)</p>
<h1>Scripting, Pt II</h1>
<p>There's a problem, though: this doesn't work with entirely vanilla scripts. I don't have <code>import variable</code> implemented for referencing variables from map scripts, so I manually edit that in. That's not the problem, though (that would be trivial to implement).</p>
<p>The problem is the part:</p>
<pre><code>   // ...
   move_inven_to_box
   move_inven_from_temp_box
</code></pre>
<p>The <code>// ...</code> is actually where the dialogue calls take place. Things in their call tree like <code>Reply</code> and <code>NOption</code>... Dialogue sessions which the script expects to block on. As evidenced by moving the inventory back into their proper boxes after calling all of the dialogue functions.</p>
<p>This is a problem, because our scripts are just interpreted JavaScript -- we cannot really control the execution. We use asynchronous APIs for the dialogue UI. We cannot busy-wait: that would be terrible and most JS engines are single-threaded. JavaScript does not have first-class support for suspending computations.</p>
<p>This is a problem in our scripting engine. I can think of two decent, viable solutions:</p>
<ul>
<li>JavaScript 1.7 Generators to suspend computation while the dialogue interface is run</li>
<li>Compiling the scripts to a virtual machine bytecode and interpreting that in JS, suspending execution when necessary</li>
</ul>
<p>The reason I didn't go ahead and implement the first options is that generators are currently (Really? It's 2014, where are my generators?) only supported by Firefox and Chrome -- and the latter requires some "Enable Experimental JavaScript" (doesn't that sound scary?) flag enabled to be used. This isn't really acceptable, because I want to target a wider variety of platforms (such as various WebKit browsers that may not use experimental V8 or SpiderMonkey features.)</p>
<p>The second option is more reasonable but I'd have to spend ~200 lines on implementing a simple stack VM that  kind of offers less information about the script, and isn't human-readable and thus harder to debug. It would, however, support anything reasonably possible with the scripting language. The <em>Fallout 2</em> engine itself uses a VM.</p>
<p>This still remains for debate. For now I will just patch scripts if I need to test bartering.</p>
<h1>Conclusion</h1>
<p>As expected, this is a fun project. A fun <em>long-term</em> project, even. It's <em>extremely</em> unusual that I stick with a project for this long, and it's a very welcome change. I hope I continue seeing it through to its end.</p>
<p>There are still have quite a few large chunks to work on -- combat (rough draft of the turn system exists, but <em>rough</em> is an understatement) and AI, skills, perks/traits, the party system, moving between maps (exit grids, ladders, elevators, scripts...), saving/loading, and animation.</p>
<p>Quite a lot has already been implemented, as well. It's come a long way since the first steps. It's fun watching the project grow and grow.</p>
<p>And at least we don't have to deal with <em>Unity</em>.</p>
<p>Until next time.</p>
</div>
</body>
</html>